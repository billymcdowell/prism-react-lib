import{j as y}from"./jsx-runtime-u17CrQMm.js";import{r as s}from"./iframe-B1FMP7ev.js";const _={damping:.7,stiffness:.05,mass:1.25},j=70,P=1e3/60,H=350;let x=!1;globalThis.document?.addEventListener("mousedown",()=>{x=!0});globalThis.document?.addEventListener("mouseup",()=>{x=!1});globalThis.document?.addEventListener("click",()=>{x=!1});const q=(a={})=>{const[c,l]=s.useState(!1),[u,f]=s.useState(a.initial!==!1),[C,A]=s.useState(!1),p=s.useRef(null);p.current=a;const v=s.useCallback(()=>{if(!x)return!1;const t=window.getSelection();if(!t||!t.rangeCount)return!1;const o=t.getRangeAt(0);return o.commonAncestorContainer.contains(r.current)||r.current?.contains(o.commonAncestorContainer)},[]),m=s.useCallback(t=>{e.isAtBottom=t,f(t)},[]),d=s.useCallback(t=>{e.escapedFromLock=t,l(t)},[]),e=s.useMemo(()=>{let t;return{escapedFromLock:c,isAtBottom:u,resizeDifference:0,accumulated:0,velocity:0,listeners:new Set,get scrollTop(){return r.current?.scrollTop??0},set scrollTop(o){r.current&&(r.current.scrollTop=o,e.ignoreScrollToTop=r.current.scrollTop)},get targetScrollTop(){return!r.current||!h.current?0:r.current.scrollHeight-1-r.current.clientHeight},get calculatedTargetScrollTop(){if(!r.current||!h.current)return 0;const{targetScrollTop:o}=this;if(!a.targetScrollTop)return o;if(t?.targetScrollTop===o)return t.calculatedScrollTop;const n=Math.max(Math.min(a.targetScrollTop(o,{scrollElement:r.current,contentElement:h.current}),o),0);return t={targetScrollTop:o,calculatedScrollTop:n},requestAnimationFrame(()=>{t=void 0}),n},get scrollDifference(){return this.calculatedTargetScrollTop-this.scrollTop},get isNearBottom(){return this.scrollDifference<=j}}},[]),b=s.useCallback((t={})=>{typeof t=="string"&&(t={animation:t}),t.preserveScrollPosition||m(!0);const o=Date.now()+(Number(t.wait)||0),n=N(p.current,t.animation),{ignoreEscapes:i=!1}=t;let T,g=e.calculatedTargetScrollTop;t.duration instanceof Promise?t.duration.finally(()=>{T=Date.now()}):T=o+(t.duration??0);const w=async()=>{const I=new Promise(requestAnimationFrame).then(()=>{if(!e.isAtBottom)return e.animation=void 0,!1;const{scrollTop:B}=e,D=performance.now(),M=(D-(e.lastTick??D))/P;if(e.animation||(e.animation={behavior:n,promise:I,ignoreEscapes:i}),e.animation.behavior===n&&(e.lastTick=D),v()||o>Date.now())return w();if(B<Math.min(g,e.calculatedTargetScrollTop)){if(e.animation?.behavior===n){if(n==="instant")return e.scrollTop=e.calculatedTargetScrollTop,w();e.velocity=(n.damping*e.velocity+n.stiffness*e.scrollDifference)/n.mass,e.accumulated+=e.velocity*M,e.scrollTop+=e.accumulated,e.scrollTop!==B&&(e.accumulated=0)}return w()}return T>Date.now()?(g=e.calculatedTargetScrollTop,w()):(e.animation=void 0,e.scrollTop<e.calculatedTargetScrollTop?b({animation:N(p.current,p.current.resize),ignoreEscapes:i,duration:Math.max(0,T-Date.now())||void 0}):e.isAtBottom)});return I.then(B=>(requestAnimationFrame(()=>{e.animation||(e.lastTick=void 0,e.velocity=0)}),B))};return t.wait!==!0&&(e.animation=void 0),e.animation?.behavior===n?e.animation.promise:w()},[m,v,e]),S=s.useCallback(()=>{d(!0),m(!1)},[d,m]),k=s.useCallback(({target:t})=>{if(t!==r.current)return;const{scrollTop:o,ignoreScrollToTop:n}=e;let{lastScrollTop:i=o}=e;e.lastScrollTop=o,e.ignoreScrollToTop=void 0,n&&n>o&&(i=n),A(e.isNearBottom),setTimeout(()=>{if(e.resizeDifference||o===n)return;if(v()){d(!0),m(!1);return}const T=o>i,g=o<i;if(e.animation?.ignoreEscapes){e.scrollTop=i;return}g&&(d(!0),m(!1)),T&&d(!1),!e.escapedFromLock&&e.isNearBottom&&m(!0)},1)},[d,m,v,e]),E=s.useCallback(({target:t,deltaY:o})=>{let n=t;for(;!["scroll","auto"].includes(getComputedStyle(n).overflow);){if(!n.parentElement)return;n=n.parentElement}n===r.current&&o<0&&r.current.scrollHeight>r.current.clientHeight&&!e.animation?.ignoreEscapes&&(d(!0),m(!1))},[d,m,e]),r=L(t=>{r.current?.removeEventListener("scroll",k),r.current?.removeEventListener("wheel",E),t?.addEventListener("scroll",k,{passive:!0}),t?.addEventListener("wheel",E,{passive:!0})},[]),h=L(t=>{if(e.resizeObserver?.disconnect(),!t)return;let o;e.resizeObserver=new ResizeObserver(([n])=>{const{height:i}=n.contentRect,T=i-(o??i);if(e.resizeDifference=T,e.scrollTop>e.targetScrollTop&&(e.scrollTop=e.targetScrollTop),A(e.isNearBottom),T>=0){const g=N(p.current,o?p.current.resize:p.current.initial);b({animation:g,wait:!0,preserveScrollPosition:!0,duration:g==="instant"?void 0:H})}else e.isNearBottom&&(d(!1),m(!0));o=i,requestAnimationFrame(()=>{setTimeout(()=>{e.resizeDifference===T&&(e.resizeDifference=0)},1)})}),e.resizeObserver?.observe(t)},[]);return{contentRef:h,scrollRef:r,scrollToBottom:b,stopScroll:S,isAtBottom:u||C,isNearBottom:C,escapedFromLock:c,state:e}};function L(a,c){const l=s.useCallback(u=>(l.current=u,a(u)),c);return l}const R=new Map;function N(...a){const c={..._};let l=!1;for(const f of a){if(f==="instant"){l=!0;continue}typeof f=="object"&&(l=!1,c.damping=f.damping??c.damping,c.stiffness=f.stiffness??c.stiffness,c.mass=f.mass??c.mass)}const u=JSON.stringify(c);return R.has(u)||R.set(u,Object.freeze(c)),l?"instant":R.get(u)}const z=s.createContext(null),O=typeof window<"u"?s.useLayoutEffect:s.useEffect;function F({instance:a,children:c,resize:l,initial:u,mass:f,damping:C,stiffness:A,targetScrollTop:p,contextRef:v,...m}){const d=s.useRef(null),e=s.useCallback((i,T)=>(n?.targetScrollTop??p)?.(i,T)??i,[p]),b=q({mass:f,damping:C,stiffness:A,resize:l,initial:u,targetScrollTop:e}),{scrollRef:S,contentRef:k,scrollToBottom:E,stopScroll:r,isAtBottom:h,escapedFromLock:t,state:o}=a??b,n=s.useMemo(()=>({scrollToBottom:E,stopScroll:r,scrollRef:S,isAtBottom:h,escapedFromLock:t,contentRef:k,state:o,get targetScrollTop(){return d.current},set targetScrollTop(i){d.current=i}}),[E,h,k,S,r,t,o]);return s.useImperativeHandle(v,()=>n,[n]),O(()=>{S.current&&getComputedStyle(S.current).overflow==="visible"&&(S.current.style.overflow="auto")},[]),y.jsx(z.Provider,{value:n,children:y.jsx("div",{...m,children:typeof c=="function"?c(n):c})})}(function(a){function c({children:l,...u}){const f=U();return y.jsx("div",{ref:f.scrollRef,style:{height:"100%",width:"100%"},children:y.jsx("div",{...u,ref:f.contentRef,children:typeof l=="function"?l(f):l})})}a.Content=c})(F||(F={}));function U(){const a=s.useContext(z);if(!a)throw new Error("use-stick-to-bottom component context must be used within a StickToBottom component");return a}export{F as S,U as u};
